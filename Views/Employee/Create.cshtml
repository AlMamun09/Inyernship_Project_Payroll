@model PayrollProject.ViewModel.EmployeeViewModels.EmployeeVM
@{
    ViewData["Title"] = ViewBag?.Title ?? "Employee";
    var shifts = ViewBag?.Shifts as IEnumerable<PayrollProject.DataModels.Shift> ?? Enumerable.Empty<PayrollProject.DataModels.Shift>();
    var formAction = ViewBag?.FormAction as string ?? Url.Action("Create", "Employee");
}

<div class="p-3">
    <form id="employeeForm" method="post" action="@formAction">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="EmployeeId" />
        <div class="card mb-0">
            <div class="card-header">
                <h3 class="card-title m-0">
                    <i class="fas fa-user-plus mr-2"></i>@ViewData["Title"]
                </h3>
                <div class="card-tools">
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-1"></i> Back to List
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    @if (Model.EmployeeId != Guid.Empty)
                    {
                        <div class="form-group col-md-3">
                            <label asp-for="EmployeeCode" class="control-label"></label>
                            <input asp-for="EmployeeCode" class="form-control" readonly />
                        </div>
                    }
                    <div class="form-group @(Model.EmployeeId != Guid.Empty ? "col-md-3" : "col-md-6")">
                        <label asp-for="FullName" class="control-label"></label>
                        <input asp-for="FullName" class="form-control" />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-3">
                        <label asp-for="Gender" class="control-label"></label>
                        <select asp-for="Gender" class="form-control">
                            <option value="">-- Select --</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                        <span asp-validation-for="Gender" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-3">
                        <label asp-for="DateOfBirth" class="control-label"></label>
                        <div class="input-group">
                            <input asp-for="DateOfBirth" type="date" class="form-control" />
                            <div class="input-group-append">
                                <span class="input-group-text" id="ageDisplay" style="width: 60px;">--</span>
                            </div>
                        </div>
                        <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="Designation" class="control-label"></label>
                        <input asp-for="Designation" class="form-control" />
                        <span asp-validation-for="Designation" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="Department" class="control-label"></label>
                        <input asp-for="Department" class="form-control" />
                        <span asp-validation-for="Department" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="JoiningDate" class="control-label"></label>
                        <input asp-for="JoiningDate" type="date" class="form-control"
                               data-val="true"
                               data-val-eighteen="Employee must be 18 or older at the time of joining."
                               data-val-eighteen-dobfield="DateOfBirth" />
                        <span asp-validation-for="JoiningDate" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="ShiftId" class="control-label"></label>
                        <select asp-for="ShiftId" class="form-control">
                            <option value="">-- Select --</option>
                            @foreach (var s in shifts)
                            {
                                <option value="@s.ShiftId">@s.ShiftName</option>
                            }
                        </select>
                        <span asp-validation-for="ShiftId" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-6">
                        <label asp-for="Status" class="control-label"></label>
                        <select asp-for="Status" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                        <span asp-validation-for="Status" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="BasicSalary" class="control-label"></label>
                        <input asp-for="BasicSalary" class="form-control" />
                        <span asp-validation-for="BasicSalary" class="text-danger"></span>
                    </div>
                    <div class="form-group col-md-4">
                        <label asp-for="EmploymentType" class="control-label"></label>
                        <select asp-for="EmploymentType" class="form-control">
                            <option>Full-Time</option>
                            <option>Part-Time</option>
                            <option>Contract</option>
                        </select>
                        <span asp-validation-for="EmploymentType" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group col-md-4">
                        <label asp-for="PaymentSystem" class="control-label"></label>
                        <select asp-for="PaymentSystem" class="form-control" id="paymentSystemSelect">
                            <option value="">-- Select Payment System --</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Mobile Banking">Mobile Banking</option>
                            <option value="Cash Payment">Cash Payment</option>
                        </select>
                        <span asp-validation-for="PaymentSystem" class="text-danger"></span>
                    </div>
                    <div class="col-md-8"></div>
                    <div class="row col-12 payment-field-group" id="bankTransferFields" style="display:none;">
                        <div class="form-group col-md-4">
                            <label asp-for="AccountHolderName" class="control-label"></label>
                            <input asp-for="AccountHolderName" class="form-control" />
                            <span asp-validation-for="AccountHolderName" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-4">
                            <label asp-for="BankAndBranchName" class="control-label"></label>
                            <input asp-for="BankAndBranchName" class="form-control" />
                            <span asp-validation-for="BankAndBranchName" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-4">
                            <label asp-for="BankAccountNumber" class="control-label"></label>
                            <input asp-for="BankAccountNumber" class="form-control" />
                            <span asp-validation-for="BankAccountNumber" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row col-12 payment-field-group" id="mobileBankingFields" style="display:none;">
                        <div class="form-group col-md-4">
                            <label asp-for="MobileNumber" class="control-label"></label>
                            <input asp-for="MobileNumber" class="form-control" />
                            <span asp-validation-for="MobileNumber" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Save</button>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(function () {
            // Find the anti-forgery token on the page and store it for AJAX
            var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenInput) {
                window.__AntiForgeryToken = tokenInput.value;
            }

            // --- 1. AGE CALCULATION (Using your logic) ---

            function updateCurrentAge() {
                // Get value from the ASP.NET-generated ID
                const dobString = $('#DateOfBirth').val();
                if (!dobString) {
                    $('#ageDisplay').text('--'); // Update the display span
                    return;
                }

                const dob = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }

                // Update the display span we added to the HTML
                const ageText = (age < 0 || isNaN(age)) ? '--' : age + ' yrs';
                $('#ageDisplay').text(ageText);
            }

            // Attach the event listener to the DOB input
            $('#DateOfBirth').on('change', updateCurrentAge);

            // Run on page load for "Edit" mode to show existing age
            updateCurrentAge();


            // --- 2. JOINING DATE VALIDATION (Using your logic) ---

            // 2a. Add the custom validation method to jQuery Validator
            $.validator.addMethod("eighteenOrOlder", function (value, element, params) {
                // 'value' is the JoiningDate (from 'element')
                // 'params' is the selector for the DateOfBirth input
                const dobString = $(params).val();
                const joiningDateString = value;

                // Don't validate if either is empty; [Required] will catch it
                if (!dobString || !joiningDateString) {
                    return true;
                }

                // Your validation logic:
                const dob = new Date(dobString);
                const joining = new Date(joiningDateString);

                let ageAtJoining = joining.getFullYear() - dob.getFullYear();
                const monthDiff = joining.getMonth() - dob.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && joining.getDate() < dob.getDate())) {
                    ageAtJoining--;
                }

                // Return true if valid (18+), false if invalid
                return ageAtJoining >= 18;
            });

            // 2b. Link this new method to 'unobtrusive' validation
            // This connects our method to the 'data-val-eighteen' attribute
            $.validator.unobtrusive.adapters.add(
                'eighteen', ['dobfield'], function (options) {
                    options.rules['eighteenOrOlder'] = '#' + options.params.dobfield;
                    options.messages['eighteenOrOlder'] = options.message;
                }
            );

        // --- 3. PAYMENT SYSTEM CONDITIONAL LOGIC ---
        const $paymentSelect = $('#paymentSystemSelect');
        const $bankFields = $('#bankTransferFields');
        const $mobileFields = $('#mobileBankingFields');

        function togglePaymentFields() {
            const selectedSystem = $paymentSelect.val();

            if (selectedSystem === 'Bank Transfer') {
                $bankFields.show();
                $mobileFields.hide();
            } else if (selectedSystem === 'Mobile Banking') {
                $bankFields.hide();
                $mobileFields.show();
            } else { // Cash Payment or -- Select --
                $bankFields.hide();
                $mobileFields.hide();
            }
        }

        // Attach event handler
        $paymentSelect.on('change', togglePaymentFields);

        // Run on page load (for Edit mode) to set the correct state
        togglePaymentFields();
        // --- END OF PAYMENT LOGIC ---
            // --- 4. AJAX FORM SUBMISSION ---
            $('#employeeForm').on('submit', function (e) {
                e.preventDefault(); // Stop the normal (non-AJAX) form submit

                var $form = $(this);

                // Manually trigger client-side validation
                // This will NOW include your "eighteenOrOlder" check
                if (!$form.valid()) {
                    return; // Don't submit if validation fails
                }

                var url = $form.attr('action');
                var data = $form.serialize();

                // Use your global CommonAjax function to post the form
                CommonAjax.ajaxPost(url, data)
                    .done(function (resp) {
                        // Show success message
                        CommonAjax.toastSuccess(resp.message || 'Saved successfully!')
                            .then(() => {
                                // Redirect back to the employee list
                                window.location.href = '@Url.Action("Index", "Employee")';
                            });
                    })
                    .fail(function (xhr) {
                        // Show error message
                        CommonAjax.toastError(xhr.responseJSON?.message || 'An error occurred.');
                    });
            });
        });
    </script>
}
